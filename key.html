<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<title>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞</title>
		<link rel="stylesheet" href="dashboard.css" />
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
		/>
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap"
			rel="stylesheet"
		/>
	</head>
	<body>
		<div class="container">
			<!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
			<aside class="sidebar">
				<img src="logo.png" alt="–ì–µ—Ä–±" class="logo" />
				<ul class="menu">
					<li>
						<a href="dashboard.html"><i class="fas fa-th-large"></i> –£—Å–ª—É–≥–∏</a>
					</li>
					<li>
						<a href="requests.html"
							><i class="fas fa-file-alt"></i> –ü–æ–¥–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏</a
						>
					</li>
					<li>
						<a href="workflow.html"
							><i class="fas fa-network-wired"></i> –ü–æ—Ç–æ–∫–∏ —Ä–∞–±–æ—Ç
							<span class="badge">65</span></a
						>
					</li>
					<li>
						<a href="instructions.html"
							><i class="fas fa-book"></i> –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</a
						>
					</li>
					<li>
						<a href="digital-cert.html"
							><i class="fas fa-certificate"></i> Digital CERT</a
						>
					</li>
					<li>
						<a href="support.html"
							><i class="fas fa-headset"></i> –°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏</a
						>
					</li>
					<li>
						<a href="news.html"
							><i class="fas fa-bullhorn"></i> –û–±—ä—è–≤–ª–µ–Ω–∏—è
							<span class="badge">4</span></a
						>
					</li>
				</ul>
				<div class="lang-exit">
					<div class="lang-switch">
						<img src="https://flagcdn.com/w40/ru.png" alt="RU" />
						<img src="https://flagcdn.com/w40/kz.png" alt="KZ" />
					</div>
					<a href="#"><i class="fas fa-sign-out-alt"></i> –í—ã—Ö–æ–¥</a>
				</div>
			</aside>

			<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
			<main class="main-content">
				<div class="top-bar"><span class="username">–ê–º–∏—Ä–æ–≤ –ê–π–¥—ã–Ω</span></div>
				<h2 class="section-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞</h2>

				<form id="editForm" class="form-box">
					<label>üìÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ (PDF):</label>
					<input type="file" id="protocolFile" accept=".pdf" required />

					<label>‚úçÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏:</label>
					<input
						type="file"
						id="signatureImage"
						accept="image/png, image/jpeg"
						required
					/>

					<label>üìå –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–µ—á–∞—Ç–∏:</label>
					<input
						type="file"
						id="stampImage"
						accept="image/png, image/jpeg"
						required
					/>

					<label>üîê –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –≠–¶–ü (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è PDF):</label>
					<input type="file" id="certFile" accept=".p12,.pfx" required />

					<button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
				</form>

				<!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
				<div id="preview" style="display: none; margin-top: 30px">
					<h3>üìÑ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
					<p><strong>–ü–æ–¥–ø–∏—Å—å:</strong></p>
					<img id="signaturePreview" style="max-width: 200px" />
					<p><strong>–ü–µ—á–∞—Ç—å:</strong></p>
					<img id="stampPreview" style="max-width: 200px" />
				</div>

				<!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∞—Ç—å -->
				<div id="downloadSection" style="display: none; margin-top: 20px">
					<button type="button" onclick="generatePDF()">
						üì• –°–∫–∞—á–∞—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª
					</button>
				</div>
			</main>
		</div>

		<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º pdf-lib –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º -->
		<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
		<script>
			const { PDFDocument, StandardFonts } = PDFLib
		</script>

		<script>
			let signatureDataURL, stampDataURL

			document
				.getElementById('editForm')
				.addEventListener('submit', function (e) {
					e.preventDefault()

					const signatureFile =
						document.getElementById('signatureImage').files[0]
					const stampFile = document.getElementById('stampImage').files[0]

					if (!signatureFile || !stampFile) {
						alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏ –∏ –ø–µ—á–∞—Ç–∏.')
						return
					}

					const reader1 = new FileReader()
					const reader2 = new FileReader()

					reader1.onload = function (e1) {
						signatureDataURL = e1.target.result
						document.getElementById('signaturePreview').src = signatureDataURL

						reader2.onload = function (e2) {
							stampDataURL = e2.target.result
							document.getElementById('stampPreview').src = stampDataURL

							document.getElementById('preview').style.display = 'block'
							document.getElementById('downloadSection').style.display = 'block'
							alert('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —Å–∫–∞—á–∞—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª.')
						}

						reader2.readAsDataURL(stampFile)
					}

					reader1.readAsDataURL(signatureFile)
				})

			async function generatePDF() {
				try {
					const protocolFile = document.getElementById('protocolFile').files[0]
					if (!protocolFile) {
						alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ PDF —Ñ–∞–π–ª –ø—Ä–æ—Ç–æ–∫–æ–ª–∞.')
						return
					}

					const reader = new FileReader()
					reader.onload = async function (e) {
						try {
							const existingPdfBytes = e.target.result
							const pdfDoc = await PDFDocument.load(existingPdfBytes)

							const sigBytes = await fetch(signatureDataURL).then(r =>
								r.arrayBuffer()
							)
							const stampBytes = await fetch(stampDataURL).then(r =>
								r.arrayBuffer()
							)

							const signatureImg = await pdfDoc.embedPng(sigBytes)
							const stampImg = await pdfDoc.embedPng(stampBytes)

							const font = await pdfDoc.embedFont(StandardFonts.Helvetica)
							const pages = pdfDoc.getPages()
							const lastPage = pages[pages.length - 1]

							// –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–º–æ–∂–Ω–æ –ø–æ–¥–æ–≥–Ω–∞—Ç—å –ø–æ–¥ —Ç–≤–æ–π —à–∞–±–ª–æ–Ω)
							lastPage.drawImage(signatureImg, {
								x: 100,
								y: 90,
								width: 100,
								height: 40,
							})
							lastPage.drawText('–ò–Ω–∂–µ–Ω–µ—Ä –∏—Å–ø—ã—Ç–∞—Ç–µ–ª—å:   –°–µ–º–∏–±–∞–π –ê.–ë.', {
								x: 100,
								y: 75,
								size: 10,
								font: font,
							})
							lastPage.drawImage(stampImg, {
								x: 270,
								y: 60,
								width: 80,
								height: 80,
							})

							const pdfBytes = await pdfDoc.save()
							const blob = new Blob([pdfBytes], { type: 'application/pdf' })

							const link = document.createElement('a')
							link.href = URL.createObjectURL(blob)
							link.download = '–ì–æ—Ç–æ–≤—ã–π_–ø—Ä–æ—Ç–æ–∫–æ–ª.pdf'
							document.body.appendChild(link)
							link.click()
							document.body.removeChild(link)
						} catch (err) {
							console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ PDF:', err)
							alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PDF. –°–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–Ω—Å–æ–ª—å.')
						}
					}

					reader.readAsArrayBuffer(protocolFile)
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF:', error)
					alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF')
				}
			}
		</script>
	</body>
</html>
